<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bestiary Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Crimson Text', serif;
      background: #0a0a0a;
      color: #d4c5a0;
      padding: 20px;
    }
    h1 {
      font-family: 'Cinzel', serif;
      text-align: center;
      color: #c9b896;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .controls {
      background: rgba(20,15,10,0.8);
      padding: 20px;
      border: 1px solid rgba(100,80,60,0.3);
      margin-bottom: 20px;
    }
    .creature-list {
      display: grid;
      gap: 15px;
    }
    .creature-card {
      background: rgba(20,15,10,0.8);
      border: 1px solid rgba(100,80,60,0.3);
      padding: 15px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 15px;
      align-items: center;
    }
    .creature-info h3 {
      font-family: 'Cinzel', serif;
      color: #c9b896;
      margin-bottom: 5px;
    }
    .creature-info p {
      color: #8a7a5a;
      font-size: 0.9rem;
    }
    button {
      background: rgba(80,60,40,0.5);
      border: 1px solid rgba(120,90,60,0.5);
      color: #c9b896;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    button:hover {
      background: rgba(100,75,50,0.6);
      border-color: rgba(150,120,80,0.7);
    }
    .add-btn {
      width: 100%;
      padding: 15px;
      background: rgba(60,80,40,0.5);
      border-color: rgba(80,120,60,0.5);
    }
    .add-btn:hover {
      background: rgba(70,100,50,0.6);
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: rgba(20,15,10,0.98);
      border: 2px solid rgba(100,80,60,0.6);
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 15px;
      font-size: 1.2rem;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      color: #c9b896;
      margin-bottom: 5px;
      font-family: 'Cinzel', serif;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(100,80,60,0.4);
      color: #d4c5a0;
      font-family: 'Crimson Text', serif;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .qr-modal-content {
      text-align: center;
      padding: 40px;
    }
    #qrcode {
      display: inline-block;
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .url-display {
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border: 1px solid rgba(100,80,60,0.4);
      margin-top: 20px;
      word-break: break-all;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bestiary Admin Panel</h1>
    
    <div class="controls">
      <button class="add-btn" onclick="openAddModal()">+ Add New Creature</button>
    </div>

    <div class="creature-list" id="creatureList"></div>
  </div>

  <!-- Edit/Add Creature Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeEditModal()">×</button>
      <h2 id="modalTitle" style="font-family: 'Cinzel', serif; color: #c9b896; margin-bottom: 20px;">Add Creature</h2>
      
      <form id="creatureForm">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="name" required>
        </div>

        <div class="form-group">
          <label>Category *</label>
          <select id="category">
            <option>Aberration</option>
            <option>Beast</option>
            <option>Celestial</option>
            <option>Construct</option>
            <option>Dragon</option>
            <option>Elemental</option>
            <option>Fey</option>
            <option>Fiend</option>
            <option>Giant</option>
            <option>Humanoid</option>
            <option selected>Monstrosity</option>
            <option>Ooze</option>
            <option>Plant</option>
            <option>Undead</option>
          </select>
        </div>

        <div class="form-group">
          <label>Size</label>
          <select id="size">
            <option>Tiny</option>
            <option>Small</option>
            <option selected>Medium</option>
            <option>Large</option>
            <option>Huge</option>
            <option>Gargantuan</option>
          </select>
        </div>

        <div class="form-group">
          <label>Type</label>
          <input type="text" id="type">
        </div>

        <div class="form-group">
          <label>Alignment</label>
          <input type="text" id="alignment">
        </div>

        <div class="form-group">
          <label>Armor</label>
          <input type="text" id="armor">
        </div>

        <div class="form-group">
          <label>Movement</label>
          <input type="text" id="movement">
        </div>

        <div class="form-group">
          <label>Temperament</label>
          <input type="text" id="temperament">
        </div>

<div class="form-group">
          <label>Vulnerabilities</label>
          <div id="vulnSelector" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
            <!-- Icons will be populated by JS -->
          </div>
          <div id="selectedVulns" style="margin-top: 15px;">
            <!-- Selected vulnerabilities will appear here -->
          </div>
        </div>

        <div class="form-group">
          <label>Description *</label>
          <textarea id="description" required></textarea>
        </div>

        <div class="form-group">
          <label>Abilities</label>
          <textarea id="abilities"></textarea>
        </div>

        <div class="form-group">
          <label>Habitat</label>
          <textarea id="habitat"></textarea>
        </div>

        <div class="form-group">
          <label>Diet</label>
          <textarea id="diet"></textarea>
        </div>

        <div class="form-group">
          <label>Behavior</label>
          <textarea id="behavior"></textarea>
        </div>

        <div class="form-group">
          <label>Lore & Myths</label>
          <textarea id="lore"></textarea>
        </div>

        <div class="form-group">
          <label>Combat Tactics</label>
          <textarea id="tactics"></textarea>
        </div>

        <div class="form-group">
          <label>Additional Notes</label>
          <textarea id="notes"></textarea>
        </div>

        <div class="form-group">
          <label>Image URL</label>
          <input type="url" id="image">
        </div>

        <button type="submit" style="width: 100%; padding: 15px;">Save Creature</button>
      </form>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-content qr-modal-content">
      <button class="modal-close" onclick="closeQRModal()">×</button>
      <h2 id="qrCreatureName" style="font-family: 'Cinzel', serif; color: #c9b896;"></h2>
      <div id="qrcode"></div>
      <p style="color: #8a7a5a;">Display this QR code for players to scan</p>
      <div class="url-display" id="creatureUrl"></div>
    </div>
  </div>

 <script>
    let creatures = [];
    let editingIndex = -1;
    let baseURL = window.location.origin + window.location.pathname.replace('admin.html', '');
    let githubToken = localStorage.getItem('github_token') || '';
    const GITHUB_OWNER = 'oathbounddnd';  // Your GitHub username
    const GITHUB_REPO = 'bestiary';        // Your repo name
    const GITHUB_BRANCH = 'main';          // Usually 'main' or 'gh-pages'

    // Check if token is set
    if (!githubToken) {
      const token = prompt('Enter your GitHub Personal Access Token (this will be stored locally):\n\nCreate one at: https://github.com/settings/tokens');
      if (token) {
        localStorage.setItem('github_token', token);
        githubToken = token;
      } else {
        alert('GitHub token required for auto-save. You can add it later by refreshing the page.');
      }
    }

    // Load creatures from JSON file
    async function loadCreatures() {
      try {
        const response = await fetch('creatures.json?t=' + Date.now()); // Cache bust
        const data = await response.json();
        creatures = data.creatures || [];
        renderList();
      } catch (error) {
        console.error('Error loading creatures:', error);
        creatures = [];
        renderList();
      }
    }

    // Save creatures to GitHub
    async function saveCreatures() {
      if (!githubToken) {
        alert('GitHub token not set. Please refresh the page and enter your token.');
        return;
      }

      const data = { creatures: creatures };
      const jsonStr = JSON.stringify(data, null, 2);
      const base64Content = btoa(unescape(encodeURIComponent(jsonStr)));

      try {
        // Get current file SHA
        const getResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/creatures.json?ref=${GITHUB_BRANCH}`,
          {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          }
        );

        let sha = '';
        if (getResponse.ok) {
          const fileData = await getResponse.json();
          sha = fileData.sha;
        }

        // Update file
        const updateResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/creatures.json`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: 'Update creatures.json',
              content: base64Content,
              sha: sha,
              branch: GITHUB_BRANCH
            })
          }
        );

        if (updateResponse.ok) {
          alert('✓ Saved! Changes will be live in ~30 seconds.');
        } else {
          const error = await updateResponse.json();
          console.error('GitHub API error:', error);
          alert('Error saving to GitHub: ' + (error.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error saving creatures:', error);
        alert('Error saving to GitHub. Check console for details.');
      }
    }

    // Render creature list
    function renderList() {
      const list = document.getElementById('creatureList');
      list.innerHTML = creatures.map((c, i) => `
        <div class="creature-card">
          <div class="creature-info">
            <h3>${c.name}</h3>
            <p>${c.size} ${c.type || c.category} - ${c.category}</p>
          </div>
          <button onclick="editCreature(${i})">Edit</button>
          <button onclick="generateQR(${i})">Generate QR</button>
        </div>
      `).join('');
    }

    // Open add modal
    function openAddModal() {
      editingIndex = -1;
      document.getElementById('modalTitle').textContent = 'Add Creature';
      document.getElementById('creatureForm').reset();
      document.getElementById('editModal').classList.add('active');
    }

// Edit creature
    function editCreature(index) {
      editingIndex = index;
      const c = creatures[index];
      
      document.getElementById('modalTitle').textContent = 'Edit Creature';
      document.getElementById('name').value = c.name || '';
      document.getElementById('category').value = c.category || 'Monstrosity';
      document.getElementById('size').value = c.size || 'Medium';
      document.getElementById('type').value = c.type || '';
      document.getElementById('alignment').value = c.alignment || '';
      document.getElementById('armor').value = c.armor || '';
      document.getElementById('movement').value = c.movement || '';
      document.getElementById('temperament').value = c.temperament || '';
      
      // Load existing vulnerabilities
      selectedVulnerabilities = [];
      if (c.vulnerabilities) {
        c.vulnerabilities.forEach(v => {
          selectedVulnerabilities.push({
            key: v,
            details: c.vulnerabilityDetails?.[v] || ''
          });
        });
      }
      renderVulnSelector();
      
      document.getElementById('description').value = c.description || '';
      document.getElementById('abilities').value = c.abilities || '';
      document.getElementById('habitat').value = c.habitat || '';
      document.getElementById('diet').value = c.diet || '';
      document.getElementById('behavior').value = c.behavior || '';
      document.getElementById('lore').value = c.lore || '';
      document.getElementById('tactics').value = c.tactics || '';
      document.getElementById('notes').value = c.notes || '';
      document.getElementById('image').value = c.image || '';
      
      document.getElementById('editModal').classList.add('active');
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

// Save creature
    document.getElementById('creatureForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const vulnerabilities = selectedVulnerabilities.map(v => v.key);
      const vulnDetails = {};
      selectedVulnerabilities.forEach(v => {
        if (v.details) {
          vulnDetails[v.key] = v.details;
        }
      });

      const creature = {
        name: document.getElementById('name').value,
        category: document.getElementById('category').value,
        size: document.getElementById('size').value,
        type: document.getElementById('type').value,
        alignment: document.getElementById('alignment').value,
        armor: document.getElementById('armor').value,
        movement: document.getElementById('movement').value,
        temperament: document.getElementById('temperament').value,
        vulnerabilities: vulnerabilities,
        vulnerabilityDetails: vulnDetails,
        description: document.getElementById('description').value,
        abilities: document.getElementById('abilities').value,
        habitat: document.getElementById('habitat').value,
        diet: document.getElementById('diet').value,
        behavior: document.getElementById('behavior').value,
        lore: document.getElementById('lore').value,
        tactics: document.getElementById('tactics').value,
        notes: document.getElementById('notes').value,
        image: document.getElementById('image').value
      };

      // Remove empty fields
      Object.keys(creature).forEach(key => {
        if (!creature[key] || (Array.isArray(creature[key]) && creature[key].length === 0) || 
            (typeof creature[key] === 'object' && Object.keys(creature[key]).length === 0)) {
          delete creature[key];
        }
      });

      if (editingIndex >= 0) {
        creatures[editingIndex] = creature;
      } else {
        creatures.push(creature);
      }

      await saveCreatures();
      renderList();
      closeEditModal();
    });

    // Generate QR code
    function generateQR(index) {
      const creature = creatures[index];
      const creatureId = creature.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      const url = `${baseURL}creature.html?id=${creatureId}`;
      
      document.getElementById('qrcode').innerHTML = '';
      
      new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 400,
        height: 400
      });
      
      document.getElementById('qrCreatureName').textContent = creature.name;
      document.getElementById('creatureUrl').textContent = url;
      document.getElementById('qrModal').classList.add('active');
    }

    // Close QR modal
    function closeQRModal() {
      document.getElementById('qrModal').classList.remove('active');
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });

    // Add button to reset token
    const controls = document.querySelector('.controls');
    const resetTokenBtn = document.createElement('button');
    resetTokenBtn.textContent = 'Reset GitHub Token';
    resetTokenBtn.style.marginTop = '10px';
    resetTokenBtn.onclick = () => {
      if (confirm('Reset your GitHub token?')) {
        localStorage.removeItem('github_token');
        location.reload();
      }
    };
    controls.appendChild(resetTokenBtn);

// Vulnerability selector
    const VULN_ICONS = {
      acid: '💧', bludgeoning: '🔨', cold: '❄️', fire: '🔥', force: '✨',
      lightning: '⚡', necrotic: '💀', piercing: '🗡️', poison: '☠️',
      psychic: '🧠', radiant: '☀️', slashing: '⚔️', thunder: '🌩️',
      metal: '⚙️', crafted: '🔧', sunlight: '🌞', natural: '🌿',
      blinded: '👁️', charmed: '💖', deafened: '👂', frightened: '😨',
      paralyzed: '🥶', stunned: '💫'
    };

    let selectedVulnerabilities = [];

    function renderVulnSelector() {
      const selector = document.getElementById('vulnSelector');
      const selected = document.getElementById('selectedVulns');
      
      // Render icon selector
      selector.innerHTML = Object.entries(VULN_ICONS).map(([key, icon]) => `
        <div onclick="addVulnerability('${key}')" style="
          cursor: pointer;
          padding: 10px;
          background: rgba(0,0,0,0.4);
          border: 1px solid rgba(100,80,60,0.4);
          text-align: center;
          transition: all 0.2s;
          border-radius: 4px;
        " onmouseover="this.style.background='rgba(100,80,60,0.3)'" onmouseout="this.style.background='rgba(0,0,0,0.4)'">
          <div style="font-size: 2rem;">${icon}</div>
          <div style="font-size: 0.7rem; color: #8a7a5a; margin-top: 5px;">${key}</div>
        </div>
      `).join('');
      
      // Render selected vulnerabilities
      selected.innerHTML = selectedVulnerabilities.map((v, i) => `
        <div style="background: rgba(0,0,0,0.3); padding: 15px; margin-bottom: 10px; border: 1px solid rgba(100,80,60,0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.5rem;">${VULN_ICONS[v.key]}</span>
              <strong style="color: #c9b896;">${v.key}</strong>
            </div>
            <button type="button" onclick="removeVulnerability(${i})" style="padding: 5px 10px;">Remove</button>
          </div>
          <input type="text" value="${v.details}" onchange="updateVulnDetails(${i}, this.value)" 
            placeholder="Describe this vulnerability..." 
            style="width: 100%; padding: 8px; background: rgba(0,0,0,0.4); border: 1px solid rgba(100,80,60,0.4); color: #d4c5a0;">
        </div>
      `).join('') || '<p style="color: #8a7a5a; font-style: italic;">No vulnerabilities selected. Click icons above to add.</p>';
    }

    function addVulnerability(key) {
      if (!selectedVulnerabilities.find(v => v.key === key)) {
        selectedVulnerabilities.push({ key, details: '' });
        renderVulnSelector();
      }
    }

    function removeVulnerability(index) {
      selectedVulnerabilities.splice(index, 1);
      renderVulnSelector();
    }

    function updateVulnDetails(index, details) {
      selectedVulnerabilities[index].details = details;
    }

    // Initialize vulnerability selector when modal opens
    document.getElementById('editModal').addEventListener('transitionend', function(e) {
      if (e.propertyName === 'opacity' && this.classList.contains('active')) {
        renderVulnSelector();
      }
    });
    loadCreatures();
  </script>
</body>
</html>
