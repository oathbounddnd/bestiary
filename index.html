<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bestiary</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bestiary">
    * { box-sizing: border-box; margin: 0; padding: 0; }
body {
      font-family: 'Crimson Text', serif;
      background: #0a0a0a;
      color: #d4c5a0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      touch-action: pan-y;
    }
.sidebar {
      width: 260px;
      background: linear-gradient(90deg, rgba(15,12,10,0.95), rgba(10,8,6,0.85));
      border-right: 1px solid rgba(100,80,60,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    /* Mobile: sidebar slides in from left */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(-100%);
        width: 280px;
        max-width: 85vw;
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }
.header {
      padding: 15px;
      border-bottom: 1px solid rgba(100,80,60,0.3);
      text-align: center;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .header {
        padding-top: 60px;
      }
    }
    .header h1 {
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      color: #c9b896;
      letter-spacing: 3px;
      text-transform: uppercase;
    }
    
    /* Mobile menu button */
    .menu-btn {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 200;
      padding: 8px 12px;
      background: rgba(15,12,10,0.95);
      border: 1px solid rgba(100,80,60,0.5);
      color: #c9b896;
      font-family: 'Cinzel', serif;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    @media (max-width: 768px) {
      .menu-btn {
        display: block;
      }
    }
    
    /* Overlay for mobile sidebar */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 99;
    }
    
    @media (max-width: 768px) {
      .sidebar-overlay.active {
        display: block;
      }
    }
    .search-box {
      padding: 12px;
      border-bottom: 1px solid rgba(100,80,60,0.3);
    }
    .search-box input {
      width: 100%;
      padding: 6px 10px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(100,80,60,0.4);
      color: #d4c5a0;
      font-family: 'Crimson Text', serif;
      font-size: 0.9rem;
    }
    .search-box input:focus {
      outline: none;
      border-color: rgba(150,120,80,0.6);
    }
    .creature-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .category {
      margin-bottom: 2px;
    }
.category-header {
      padding: 6px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .category-header:hover {
      background: rgba(40,35,30,0.3);
    }
    .category-header:active {
      background: rgba(50,40,30,0.5);
    }
    .category-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid #8a7a5a;
      border-top: 3px solid transparent;
      border-bottom: 3px solid transparent;
      transition: transform 0.2s;
    }
    .category.collapsed .category-arrow {
      transform: rotate(-90deg);
    }
    .category-name {
      font-family: 'Cinzel', serif;
      font-size: 0.8rem;
      color: #8a7a5a;
      text-transform: uppercase;
      letter-spacing: 1px;
      flex: 1;
    }
    .category-count {
      font-size: 0.75rem;
      color: #6a5a4a;
    }
    .category-creatures {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .category.collapsed .category-creatures {
      max-height: 0;
    }
.creature-item {
      padding: 5px 15px 5px 30px;
      cursor: pointer;
      border-left: 2px solid transparent;
      transition: all 0.15s;
      font-size: 0.9rem;
      -webkit-tap-highlight-color: transparent;
    }
    .creature-item:hover {
      background: rgba(40,35,30,0.4);
      border-left-color: rgba(150,120,80,0.6);
    }
    .creature-item:active {
      background: rgba(50,40,30,0.6);
    }
    .creature-item.active {
      background: rgba(50,40,30,0.6);
      border-left-color: #c9b896;
      color: #c9b896;
    }
.scan-btn {
      margin: 12px;
      padding: 10px;
      background: rgba(80,60,40,0.3);
      border: 1px solid rgba(120,90,60,0.5);
      color: #c9b896;
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      -webkit-tap-highlight-color: transparent;
    }
    .scan-btn:hover {
      background: rgba(100,75,50,0.4);
      border-color: rgba(150,120,80,0.7);
    }
    .scan-btn:active {
      transform: scale(0.98);
    }
.main-content {
      flex: 1;
      display: flex;
      position: relative;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        width: 100%;
      }
    }
.creature-display {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-direction: column;
      gap: 30px;
      padding: 30px;
      overflow-y: auto;
    }
    
    @media (max-width: 768px) {
      .creature-display {
        padding: 80px 15px 15px;
        gap: 20px;
        min-height: 40vh;
      }
    }
.creature-image {
      max-width: 60%;
      max-height: 55vh;
      object-fit: contain;
      filter: drop-shadow(0 0 30px rgba(0,0,0,0.8));
    }
    
    @media (max-width: 768px) {
      .creature-image {
        max-width: 85%;
        max-height: 35vh;
      }
    }
.vulnerabilities-display {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    @media (max-width: 768px) {
      .vulnerabilities-display {
        gap: 10px;
      }
    }
.vuln-icon {
      width: 60px;
      height: 60px;
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(100,80,60,0.5);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
      -webkit-tap-highlight-color: transparent;
    }
    .vuln-icon:hover {
      border-color: rgba(150,120,80,0.8);
      background: rgba(20,15,10,0.8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.3);
    }
    
    @media (max-width: 768px) {
      .vuln-icon {
        width: 50px;
        height: 50px;
        font-size: 1.6rem;
      }
      .vuln-icon:active {
        transform: scale(0.95);
      }
    }
    .vuln-icon:hover {
      border-color: rgba(150,120,80,0.8);
      background: rgba(20,15,10,0.8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.3);
    }
.info-panel {
      width: 380px;
      background: linear-gradient(270deg, rgba(15,12,10,0.95), rgba(10,8,6,0.85));
      border-left: 1px solid rgba(100,80,60,0.3);
      overflow-y: auto;
      padding: 25px;
    }
    
    @media (max-width: 768px) {
      .info-panel {
        width: 100%;
        border-left: none;
        border-top: 1px solid rgba(100,80,60,0.3);
        padding: 20px 15px;
        max-height: 60vh;
      }
    }
    .info-title-box {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(100,80,60,0.4);
      padding: 12px 15px;
      margin-bottom: 20px;
    }
    .info-title {
      font-family: 'Cinzel', serif;
      font-size: 1.4rem;
      color: #c9b896;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin: 0;
    }
    .info-subtitle {
      font-size: 0.9rem;
      color: #8a7a5a;
      margin-top: 5px;
      font-style: italic;
    }
    .stat-block {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(100,80,60,0.3);
      padding: 12px;
      margin-bottom: 18px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(100,80,60,0.2);
      gap: 15px;
      align-items: flex-start;
    }
    .stat-row:last-child {
      border-bottom: none;
    }
    .stat-label {
      color: #8a7a5a;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
      flex-shrink: 0;
      min-width: 90px;
    }
    .stat-value {
      color: #d4c5a0;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: right;
      flex: 1;
    }
    .section {
      margin-bottom: 20px;
    }
    .section-title {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      color: #c9b896;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(100,80,60,0.3);
      padding-bottom: 6px;
    }
    .section-content {
      line-height: 1.6;
      color: #b5a585;
      font-size: 0.9rem;
    }
    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 15px;
      color: #6a5a4a;
    }
    .empty-state h2 {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      letter-spacing: 2px;
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
.modal-content {
      background: rgba(20,15,10,0.98);
      border: 2px solid rgba(100,80,60,0.6);
      padding: 25px;
      max-width: 450px;
      width: 90%;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-width: none;
        padding: 20px;
        max-height: 90vh;
      }
    }
.modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 12px;
      border: 1px solid rgba(100,80,60,0.5);
      background: rgba(80,60,40,0.3);
      color: #c9b896;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      -webkit-tap-highlight-color: transparent;
    }
    .modal-close:hover {
      background: rgba(100,75,50,0.4);
    }
    .modal-close:active {
      transform: scale(0.95);
    }
    .modal h3 {
      font-family: 'Cinzel', serif;
      color: #c9b896;
      margin-bottom: 15px;
      font-size: 1.3rem;
      letter-spacing: 1px;
    }
    .modal p {
      color: #b5a585;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    ::-webkit-scrollbar-thumb { background: rgba(100,80,60,0.5); }
    ::-webkit-scrollbar-thumb:hover { background: rgba(120,90,60,0.7); }
  </style>
</head>
<body>
  <button class="menu-btn" id="menuBtn">☰ Menu</button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h1>Bestiary</h1>
    </div>
    <div class="search-box">
      <input type="search" id="search" placeholder="Search creatures...">
    </div>
<div class="creature-list" id="creatureList"></div>
    <button class="scan-btn" id="scanBtn">Scan QR Code</button>
    <button class="scan-btn" id="installBtn" style="display: none;">📥 Install App</button>
  </div>

  <div class="main-content">
    <div class="creature-display" id="creatureDisplay">
      <div class="empty-state" id="emptyState">
        <h2>NO CREATURE SELECTED</h2>
        <p>Select a creature from the list or scan a QR code</p>
      </div>
    </div>
    <div class="info-panel" id="infoPanel" style="display:none;">
      <div id="infoContent"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeModal">Close</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script>
const STORAGE_KEY = 'bestiary_creatures';
const VERSION_KEY = 'bestiary_version';
const CURRENT_VERSION = '2.0';
const CATEGORIES = [
  'Aberration', 'Beast', 'Celestial', 'Construct', 'Dragon',
  'Elemental', 'Fey', 'Fiend', 'Giant', 'Humanoid',
  'Monstrosity', 'Ooze', 'Plant', 'Undead'
];

const VULNERABILITY_ICONS = {
      acid: { icon: '💧', name: 'Acid', desc: 'Takes extra damage from acid.' },
      bludgeoning: { icon: '🔨', name: 'Bludgeoning', desc: 'Takes extra damage from blunt force attacks.' },
      cold: { icon: '❄️', name: 'Cold', desc: 'Takes extra damage from cold and ice.' },
      fire: { icon: '🔥', name: 'Fire', desc: 'Takes extra damage from fire and heat.' },
      force: { icon: '✨', name: 'Force', desc: 'Takes extra damage from pure magical force.' },
      lightning: { icon: '⚡', name: 'Lightning', desc: 'Takes extra damage from electricity.' },
      necrotic: { icon: '💀', name: 'Necrotic', desc: 'Takes extra damage from death magic.' },
      piercing: { icon: '🗡️', name: 'Piercing', desc: 'Takes extra damage from piercing weapons.' },
      poison: { icon: '☠️', name: 'Poison', desc: 'Takes extra damage from toxins and venom.' },
      psychic: { icon: '🧠', name: 'Psychic', desc: 'Takes extra damage from mental attacks.' },
      radiant: { icon: '☀️', name: 'Radiant', desc: 'Takes extra damage from holy light.' },
      slashing: { icon: '⚔️', name: 'Slashing', desc: 'Takes extra damage from slashing weapons.' },
      thunder: { icon: '🌩️', name: 'Thunder', desc: 'Takes extra damage from sonic booms.' },
      silver: { icon: '🌙', name: 'Silver', desc: 'Vulnerable to silvered weapons.' },
      sunlight: { icon: '🌞', name: 'Sunlight', desc: 'Vulnerable to direct sunlight.' },
      natural: { icon: '🌿', name: 'Natural Materials', desc: 'Vulnerable to specific natural substances (wolfsbane, running water, etc.).' },
      metal: { icon: '⚙️', name: 'Specific Metals', desc: 'Vulnerable to certain metals (silver, iron, cold iron, etc.).' },
      crafted: { icon: '🔧', name: 'Crafted Materials', desc: 'Vulnerable to specific non-natural materials (blessed items, magical constructs, etc.).' },
      blinded: { icon: '👁️', name: 'Blinded', desc: 'Vulnerable when blinded.' },
      charmed: { icon: '💖', name: 'Charmed', desc: 'Vulnerable to charm effects.' },
      deafened: { icon: '👂', name: 'Deafened', desc: 'Vulnerable when deafened.' },
      frightened: { icon: '😨', name: 'Frightened', desc: 'Vulnerable to fear effects.' },
      paralyzed: { icon: '🥶', name: 'Paralyzed', desc: 'Vulnerable when paralyzed.' },
      stunned: { icon: '💫', name: 'Stunned', desc: 'Vulnerable to stun effects.' }
    };

    const SAMPLE_CREATURES = [
      {
        name: 'Ancient Red Dragon',
        category: 'Dragon',
        size: 'Gargantuan',
        type: 'Dragon',
        alignment: 'Chaotic Evil',
        armor: 'Thick crimson scales, nearly impenetrable',
        movement: 'Swift on ground, can climb sheer cliffs, soars majestically through the sky',
        temperament: 'Aggressive and territorial',
        vulnerabilities: ['cold'],
        vulnerabilityDetails: {
          cold: 'Red dragons despise cold and take additional damage from ice attacks.'
        },
        description: 'The most covetous of the true dragons, red dragons tirelessly seek to increase their treasure hoards. They are exceptionally vain, even for dragons, and their conceit is reflected in their proud bearing and their disdain for other creatures. Their scales shine like polished rubies, and smoke constantly wisps from their nostrils.',
        abilities: 'Possesses an almost supernatural will that allows it to shrug off magical effects that would fell lesser creatures. Its mere presence can strike terror into the hearts of even the bravest warriors. The dragon can sense the location of precious metals and gems within its territory.',
        habitat: 'Ancient red dragons make their lairs in high mountain peaks, volcanic regions, and deep caverns filled with geothermal vents. They prefer locations where the heat is intense and the air shimmers with thermal waves.',
        diet: 'Carnivorous apex predator. Prefers large game such as cattle, horses, and unfortunately, humans. Known to occasionally consume precious gems, which are believed to strengthen their scales.',
        behavior: 'Extremely territorial and will attack anything that enters its domain without permission. Spends much of its time sleeping atop its hoard or patrolling its territory from the skies. Occasionally accepts tributes from nearby settlements in exchange for peace.',
        lore: 'Legends speak of ancient red dragons living for thousands of years, their hoards growing to legendary proportions. Some tales claim that the oldest red dragons can speak the true names of fire itself, commanding flames with but a thought. One famous red dragon, Infernatrix the Eternal, is said to have laid waste to three kingdoms before finally being driven into the deep mountains.'
      },
{
        name: 'Beholder',
        category: 'Aberration',
        size: 'Large',
        type: 'Aberration',
        alignment: 'Lawful Evil',
        armor: 'Thick chitinous hide',
        movement: 'Levitates slowly through the air, never touching the ground',
        temperament: 'Paranoid and xenophobic',
        vulnerabilities: [],
        description: 'One glance at a beholder is enough to assess its foul and otherworldly nature. A bulbous floating orb dominated by a massive central eye and a gaping maw filled with razor-sharp teeth. Ten eyestalks writhe from the top of its body, each containing a smaller eye that glows with eldritch power. Aggressive, hateful, and greedy, these aberrations dismiss all other creatures as lesser beings.',
        abilities: 'Each of its ten eyestalks can project a different magical effect - some can disintegrate matter, others can turn flesh to stone, and still others can dominate minds or induce sleep. Its massive central eye projects an area where magic itself ceases to function, making it immune to most spellcasting. The creature never truly sleeps, instead entering a semi-dormant state where some eyes remain alert.',
        habitat: 'Beholders claim deep underground lairs in the Underdark, often in large caverns they reshape using their disintegration rays. They prefer locations where they can survey all approaches and create elaborate mazes of tunnels. Some are known to float in the void between dimensions.',
        diet: 'Omnivorous but prefers live prey. Uses its disintegration ray to reduce meals to manageable portions. Known to keep certain victims alive as entertainment or slaves.',
        behavior: 'Supremely paranoid and narcissistic. Each beholder believes itself to be the perfect example of beholderkind and views all other creatures - even other beholders - as inferior. They scheme constantly and trust nothing. Will often attack on sight unless a creature can offer something of significant value.',
        lore: 'Scholars debate whether beholders dream themselves into existence or if they are spawned from some nightmare realm beyond comprehension. It is said that when a beholder dreams of another beholder, that dream can manifest as a real creature - but the dreamer will inevitably view the spawn as an abomination and seek to destroy it. Ancient texts warn that some beholders have learned to manipulate reality itself through dream magic.'
      },
{
        name: 'Owlbear',
        category: 'Monstrosity',
        size: 'Large',
        type: 'Monstrosity',
        alignment: 'Unaligned',
        armor: 'Thick feathered hide',
        movement: 'Surprisingly fast runner despite its bulk',
        temperament: 'Territorial and aggressive',
        vulnerabilities: ['fire'],
        vulnerabilityDetails: {
          fire: 'Owlbears have thick feathered coats that are highly flammable.'
        },
        description: 'An owlbear\'s screech echoes through dark valleys and benighted forests, piercing the quiet night to announce the death of its prey. Feathers cover the thick, shaggy coat of its bearlike body, and the limpid pupils of its great round eyes stare furiously from its owlish head. Standing over eight feet tall, these creatures are a bizarre fusion of two apex predators.',
        abilities: 'Possesses exceptional vision and can hunt effectively even in near-total darkness. Its sense of smell rivals that of any bloodhound. When it has prey in its grasp, it will crush and tear with both beak and claws simultaneously in a devastating embrace.',
        habitat: 'Dense forests, particularly old growth with thick canopies. Sometimes found in cave systems at forest edges. They claim large territories, typically several square miles, and mark the boundaries with deep claw marks on trees and scattered remains of prey.',
        diet: 'Carnivorous and will eat almost any meat. Prefers deer, boar, and other large forest animals, but will eagerly attack travelers, livestock, or anything else that enters its territory. Known to cache excess kills in hollow trees or shallow graves.',
        behavior: 'Fiercely protective of their territory and especially their young. Most active during twilight hours. They are not pack hunters but mated pairs will cooperate to defend their nesting grounds. The distinctive screech serves both as a hunting cry and a warning to rivals.',
        lore: 'Sages debate whether owlbears are the result of ancient wizards\' experiments or some cruel trick of the gods. Local folklore warns travelers to flee immediately upon hearing their cry, as few who stand their ground survive the encounter. Some druidic circles speak of a primal owlbear spirit that embodies the savagery of the wild.'
      },
{
        name: 'Werewolf',
        category: 'Humanoid',
        size: 'Medium',
        type: 'Humanoid (shapechanger)',
        alignment: 'Chaotic Evil',
        armor: 'Tough hide when transformed, heals rapidly from most wounds',
        movement: 'Moves with predatory grace, significantly faster in wolf form',
        temperament: 'Savage and cunning',
        vulnerabilities: ['silver', 'natural'],
        vulnerabilityDetails: {
          silver: 'Werewolves are vulnerable to silvered weapons, which bypass their damage resistances and deal normal damage.',
          natural: 'Wolfsbane is toxic to werewolves. Exposure causes weakness and prevents transformation.'
        },
        description: 'A werewolf is a savage predator cursed to walk between two worlds. In humanoid form, they often appear as normal people, though some retain feral features - extra body hair, prominent canines, or eyes that reflect light like an animal\'s. When the beast takes hold, they transform into a hulking hybrid creature or a massive wolf, driven by primal hunger.',
        abilities: 'Can shift between three forms: human, wolf, and a terrifying hybrid form that combines the worst aspects of both. In hybrid form, they stand upright but possess the claws, fangs, and strength of a great predator. Their bite carries a terrible curse that can spread the lycanthropic affliction to others. They possess regenerative abilities that allow them to recover from most wounds, though silver and certain herbs can prevent this healing.',
        habitat: 'Werewolves often dwell on the fringes of civilization - in frontier towns, isolated farmsteads, or deep forests near settlements. They require access to both human society (for their cursed human side) and wild hunting grounds (for their beast nature). Many are drawn to forested regions with abundant prey.',
        diet: 'While in human form, they eat normally. Once transformed, they become ravenous carnivores with a particular hunger for human flesh. Many werewolves wake the morning after a full moon with no memory of their nocturnal hunts, only the taste of blood and the screams echoing in their nightmares.',
        behavior: 'Most werewolves struggle with their dual nature. Some embrace the beast and hunt willingly. Others fight against the curse, isolating themselves during full moons or seeking cures. When transformed, they are overcome by predatory instincts and hunt with the cunning of a human mind and the savagery of a wolf. They often hunt in packs with natural wolves, who recognize them as alpha predators.',
        lore: 'The curse of lycanthropy is said to originate from an ancient pact with dark powers or as punishment from nature gods for hunters who showed no respect for the wilderness. Silver\'s effectiveness against werewolves is attributed to the metal\'s connection to the moon. Wolfsbane, a toxic purple flower, is both a ward against werewolves and a component in various suppression remedies. Village elders tell of ways to break the curse: killing the werewolf that inflicted the bite, breaking the curse through powerful magic, or according to some tales, acts of true selflessness or love.',
        tactics: 'In combat, werewolves use their ability to shift forms tactically. They may ambush prey in wolf form for speed, transform to hybrid form to maximize their combat effectiveness, then flee in wolf form if overwhelmed. They target the weakest members of a group first and attempt to spread their curse through bites.'
      }
    ];

    let creatures = [];
    let selectedCreature = null;
    let scanner = null;
    let collapsedCategories = new Set();

async function loadCreatures() {
      // Try to load from online creatures.json first
      try {
        const response = await fetch('creatures.json?t=' + Date.now());
        if (response.ok) {
          const data = await response.json();
          if (data.creatures && data.creatures.length > 0) {
            // Merge with local creatures
            const stored = localStorage.getItem(STORAGE_KEY);
            const localCreatures = stored ? JSON.parse(stored) : [];
            
            // Add online creatures that aren't already local
            data.creatures.forEach(onlineCreature => {
              const exists = localCreatures.some(c => c.name === onlineCreature.name);
              if (!exists) {
                localCreatures.push(onlineCreature);
              }
            });
            
            creatures = localCreatures;
            saveCreatures();
          } else {
            // Fallback to localStorage
            const stored = localStorage.getItem(STORAGE_KEY);
            creatures = stored ? JSON.parse(stored) : [...SAMPLE_CREATURES];
            if (!stored) saveCreatures();
          }
        } else {
          // Fallback to localStorage
          const stored = localStorage.getItem(STORAGE_KEY);
          creatures = stored ? JSON.parse(stored) : [...SAMPLE_CREATURES];
          if (!stored) saveCreatures();
        }
      } catch (error) {
        console.log('Could not fetch online creatures, using local storage', error);
        const stored = localStorage.getItem(STORAGE_KEY);
        creatures = stored ? JSON.parse(stored) : [...SAMPLE_CREATURES];
        if (!stored) saveCreatures();
      }
      
      renderList();
      if (creatures.length > 0) {
        selectCreature(creatures[0]);
      }
    }

    function saveCreatures() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(creatures));
    }

async function addCreature(data) {
      try {
        if (data.startsWith('http://') || data.startsWith('https://')) {
          const url = new URL(data);
          const creatureId = url.searchParams.get('id');
          
          if (!creatureId) {
            alert('Invalid creature URL');
            return;
          }
          
          try {
            const response = await fetch('creatures.json?t=' + Date.now());
            const jsonData = await response.json();
            
            const creature = jsonData.creatures.find(c => {
              const id = c.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
              return id === creatureId;
            });
            
            if (!creature) {
              alert('Creature not found in database.');
              return;
            }
            
const existingIndex = creatures.findIndex(c => c.name === creature.name);
            if (existingIndex >= 0) {
              creatures[existingIndex] = creature;
              saveCreatures();
              renderList();
              selectCreature(creature);
              alert(`${creature.name} updated in your bestiary!`);
            } else {
              creatures.push(creature);
              saveCreatures();
              renderList();
              selectCreature(creature);
              alert(`${creature.name} added to your bestiary!`);
            }
          } catch (fetchError) {
            alert('Could not fetch creature data. Check your internet connection.');
            return;
          }
        } else {
          const creature = JSON.parse(data);
          const exists = creatures.some(c => c.name === creature.name);
          if (!exists) {
            creatures.push(creature);
            saveCreatures();
            renderList();
            selectCreature(creature);
            alert(`${creature.name} added to your bestiary!`);
          } else {
            alert(`${creature.name} is already in your bestiary`);
          }
        }
      } catch (e) {
        alert('Invalid QR code: ' + e.message);
      }
    }

    function toggleCategory(category) {
      if (collapsedCategories.has(category)) {
        collapsedCategories.delete(category);
      } else {
        collapsedCategories.add(category);
      }
      renderList();
    }

    function renderList(filter = '') {
      const list = document.getElementById('creatureList');
      const grouped = {};
      
      CATEGORIES.forEach(cat => grouped[cat] = []);
      
      creatures
        .filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach(c => {
          const cat = c.category || 'Monstrosity';
          if (grouped[cat]) grouped[cat].push(c);
        });

      list.innerHTML = CATEGORIES.map(category => {
        const creaturesInCat = grouped[category];
        if (creaturesInCat.length === 0) return '';
        
        const isCollapsed = collapsedCategories.has(category);
        
        return `
          <div class="category ${isCollapsed ? 'collapsed' : ''}">
            <div class="category-header" onclick="toggleCategory('${category}')">
              <div class="category-arrow"></div>
              <div class="category-name">${category}</div>
              <div class="category-count">${creaturesInCat.length}</div>
            </div>
            <div class="category-creatures">
              ${creaturesInCat.map(c => `
                <div class="creature-item ${selectedCreature?.name === c.name ? 'active' : ''}" 
                     onclick='selectCreatureByName("${c.name.replace(/'/g, "\\'")}")'>
                  ${c.name}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function selectCreatureByName(name) {
      const creature = creatures.find(c => c.name === name);
      if (creature) selectCreature(creature);
    }

    function selectCreature(creature) {
      selectedCreature = creature;
      renderList();
      showCreature(creature);
    }

    function showVulnerabilityModal(vulnKey) {
      const vuln = VULNERABILITY_ICONS[vulnKey];
      const custom = selectedCreature.vulnerabilityDetails?.[vulnKey];
      
      const modal = document.getElementById('modal');
      const body = document.getElementById('modalBody');
      
      body.innerHTML = `
        <h3>${vuln.icon} ${vuln.name}</h3>
        <p><strong>Effect:</strong> ${vuln.desc}</p>
        ${custom ? `<p><strong>Specific to ${selectedCreature.name}:</strong> ${custom}</p>` : ''}
      `;
      
      modal.classList.add('active');
    }

function showCreature(creature) {
      const display = document.getElementById('creatureDisplay');
      const panel = document.getElementById('infoPanel');
      const content = document.getElementById('infoContent');

      // Hide empty state if it exists
      const empty = document.getElementById('emptyState');
      if (empty) {
        empty.style.display = 'none';
      }
      
      panel.style.display = 'block';

      const imageHtml = creature.image ? 
        `<img src="${creature.image}" class="creature-image" alt="${creature.name}">` :
        `<div style="color:#6a5a4a;font-style:italic;font-size:1.1rem;">No image available</div>`;

      const vulnHtml = (creature.vulnerabilities && creature.vulnerabilities.length > 0) ? `
        <div class="vulnerabilities-display">
          ${creature.vulnerabilities.map(v => {
            const vuln = VULNERABILITY_ICONS[v];
            return vuln ? `<div class="vuln-icon" onclick="showVulnerabilityModal('${v}')" title="${vuln.name}">${vuln.icon}</div>` : '';
          }).join('')}
        </div>
      ` : '';

      display.innerHTML = imageHtml + vulnHtml;

     content.innerHTML = `
        <div class="info-title-box">
          <h2 class="info-title">${creature.name}</h2>
          <div class="info-subtitle">${creature.size || ''} ${creature.type || ''}, ${creature.alignment || ''}</div>
        </div>

<div class="stat-block">
          <div class="stat-row">
            <span class="stat-label">Armor</span>
            <span class="stat-value">${creature.armor || creature.ac || '—'}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Movement</span>
            <span class="stat-value">${creature.movement || creature.speed || '—'}</span>
          </div>
          ${creature.temperament ? `
          <div class="stat-row">
            <span class="stat-label">Temperament</span>
            <span class="stat-value">${creature.temperament}</span>
          </div>
          ` : ''}
        </div>

        ${creature.description ? `
          <div class="section">
            <div class="section-title">Description</div>
            <div class="section-content">${creature.description}</div>
          </div>
        ` : ''}

        ${creature.abilities ? `
          <div class="section">
            <div class="section-title">Abilities</div>
            <div class="section-content">${creature.abilities.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}

        ${creature.habitat ? `
          <div class="section">
            <div class="section-title">Habitat</div>
            <div class="section-content">${creature.habitat.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}

        ${creature.diet ? `
          <div class="section">
            <div class="section-title">Diet</div>
            <div class="section-content">${creature.diet.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}

        ${creature.behavior ? `
          <div class="section">
            <div class="section-title">Behavior</div>
            <div class="section-content">${creature.behavior.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}

        ${creature.lore ? `
          <div class="section">
            <div class="section-title">Lore & Myths</div>
            <div class="section-content">${creature.lore.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}

        ${creature.tactics ? `
          <div class="section">
            <div class="section-title">Combat Tactics</div>
            <div class="section-content">${creature.tactics.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}

        ${creature.notes ? `
          <div class="section">
            <div class="section-title">Additional Notes</div>
            <div class="section-content">${creature.notes.replace(/\n/g, '<br><br>')}</div>
          </div>
        ` : ''}
      `;
    }

    document.getElementById('scanBtn').addEventListener('click', async () => {
      const modal = document.getElementById('modal');
      const body = document.getElementById('modalBody');
      
      body.innerHTML = '<h3>QR CODE SCANNER</h3><div id="qr-reader"></div>';
      modal.classList.add('active');

      scanner = new Html5Qrcode("qr-reader");
      try {
        await scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decoded) => {
            scanner.stop();
            modal.classList.remove('active');
            addCreature(decoded);
          }
        );
      } catch (err) {
        alert('Camera not available');
        modal.classList.remove('active');
      }
    });

    document.getElementById('closeModal').addEventListener('click', () => {
      if (scanner) {
        scanner.stop().catch(() => {});
        scanner = null;
      }
      document.getElementById('modal').classList.remove('active');
    });

document.getElementById('search').addEventListener('input', (e) => {
      renderList(e.target.value);
    });

    // Mobile menu toggle
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('active');
    }
    
    function closeSidebar() {
      sidebar.classList.remove('open');
      overlay.classList.remove('active');
    }
    
    menuBtn.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    
    // Close sidebar when creature is selected on mobile
    const originalSelectCreature = selectCreature;
    selectCreature = function(creature) {
      originalSelectCreature(creature);
      if (window.innerWidth <= 768) {
        closeSidebar();
      }
    };

window.toggleCategory = toggleCategory;
    window.selectCreatureByName = selectCreatureByName;
    window.showVulnerabilityModal = showVulnerabilityModal;

loadCreatures();

    // PWA Install prompt
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        installBtn.style.display = 'none';
      }
      deferredPrompt = null;
    });
  </script>
</body>
</html>
